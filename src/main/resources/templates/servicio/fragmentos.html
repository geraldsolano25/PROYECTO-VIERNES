<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity6">
    <body>
        <!-- fragmento 1 para Agregar servicio en ventana modal -->
        <section th:fragment="agregar">
            <!-- Button trigger modal -->
            <div class='row py-4 mb-2 bg-light'>
                <div class='col-md-1'></div>
                <div class='col-md-3'>
                    <button type="button" class="btn btn-primary" sec:authorize="hasRole('ROLE_ADMIN')"
                            data-bs-toggle="modal" data-bs-target="#agregarServicioModal">
                        <i class="fa-solid fa-plus"></i> Agregar Servicio
                    </button>
                </div>
            </div>
            
            <!-- Modal -->
            <div class="modal fade" id="agregarServicioModal" tabindex="-1" 
                 aria-labelledby="agregarServicioModalLabel" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header bg-info text-white">
                            <h1 class="modal-title fs-5" id="agregarServicioModalLabel">
                                <i class="fa-solid fa-concierge-bell"></i> Agregar Servicio
                            </h1>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <form th:action='@{/servicio/guardar}' th:object='${servicio}'
                              class='was-validated' enctype="multipart/form-data" method="post">
                            <div class="modal-body">
                               

                                <div class='mb-3'>
                                    <label>Descripción</label>
                                    <input type="text" name='descripcion' class='form-control' 
                                           maxlength="50" required placeholder="Nombre del servicio"/>
                                </div>
                                
                                <div class='mb-3'>
                                    <label>Detalle</label>
                                    <textarea name='detalle' class='form-control' rows="3" 
                                              maxlength="1024" placeholder="Descripción detallada del servicio"></textarea>
                                </div>
                                
                                <div class='mb-3'>
                                    <label>Precio (₡)</label>
                                    <input type="number" name='precio' class='form-control' 
                                           min="0" step="0.01" required placeholder="0.00"/>
                                </div>
                                
                                <div class='mb-3'>
                                    <label>Duración (minutos)</label>
                                    <input type="number" name='duracionMinutos' class='form-control' 
                                           min="1" required placeholder="30"/>
                                </div>

                                <div class='mb-3'>
                                    <label>Activo</label>
                                    <input type="checkbox" name='activo' class='form-check-input' checked/>
                                </div>
                                
                                <div class='mb-3'>
                                    <label>Imagen</label>
                                    <input type="file" name='imagenFile' onchange='mostrarImagen(this);'
                                           class='form-control' accept="image/*"/>
                                    <img id='blah-servicio' src='#' alt='imagen del servicio' height="200" class="mt-2 d-none"/>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                                    <i class="fa-solid fa-xmark"></i> Cerrar
                                </button>
                                <button type="submit" class="btn btn-primary">
                                    <i class="fa-solid fa-floppy-disk"></i> Guardar
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </section>

        <!-- fragmento 2 para el listado de servicios -->
        <section th:fragment="listado" class="p-3">
            <div class="row p-3">
                <div class="col-md-9">
                    <div class="card p-2">
                        <div class="card-header">
                            <h4>Listado de Servicios</h4>
                        </div>
                        <div class="card-body">
                            <div th:if="${servicios != null and !servicios.empty}">
                                <table class="table table-striped table-hover">
                                    <thead>
                                        <tr>
                                            <th>#</th>
                                            <th>Descripción</th>
                                            <th>Precio (₡)</th>
                                            <th>Duración</th>
                                           
                                            <th>Imagen</th>
                                            <th>Estado</th>
                                            <th sec:authorize="hasRole('ROLE_ADMIN')">Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr th:each="s : ${servicios}">
                                            <td>[[${s.idServicio}]]</td>
                                            <td>[[${s.descripcion}]]</td>
                                            <td class="text-end">[[${#numbers.formatCurrency(s.precio)}]]</td>
                                            <td class="text-center">[[${s.duracionMinutos}]] min</td>
                                            <td>
                                                <img th:if="${s.rutaImagen}" 
                                                     th:src="@{${s.rutaImagen}}" 
                                                     alt="imagen" 
                                                     height="60"
                                                     class="img-thumbnail">
                                                <span th:unless="${s.rutaImagen}" class="text-muted">Sin imagen</span>
                                            </td>
                                            <td>
                                                <span th:if="${s.activo}" class="badge bg-success">Activo</span>
                                                <span th:unless="${s.activo}" class="badge bg-danger">Inactivo</span>
                                            </td>
                                            <td sec:authorize="hasRole('ROLE_ADMIN')">
                                                <button type="button" class="btn btn-danger btn-sm"
                                                        data-bs-toggle="modal" 
                                                        data-bs-target="#confirmModalServicio"
                                                        th:data-bs-id="${s.idServicio}"
                                                        th:data-bs-descripcion="${s.descripcion}">
                                                    <i class="fa-solid fa-trash"></i>
                                                </button>                                           
                                                <a th:href="@{/servicio/modificar/}+${s.idServicio}" 
                                                   class="btn btn-warning btn-sm">
                                                    <i class="fas fa-pencil-alt"></i>
                                                </a>                                                
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            <div class="text-center p-2" th:if="${servicios == null or servicios.empty}">
                                <span>No hay servicios registrados</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-center bg-success text-white mb-3">
                        <div class="card-body">
                            <h3>Total Servicios</h3>
                            <h4 class="fs-2"><i class="fas fa-concierge-bell"></i> [[${totalServicios}]]</h4>
                        </div>
                    </div>
                    
                    <!-- Opcional: Estadísticas -->
                    <div class="card text-center bg-info text-white mb-3">
                        <div class="card-body">
                            <h5>Servicios Activos</h5>
                            <h4 class="fs-4">
                                [[${servicios.?[activo == true].size()}]] / [[${totalServicios}]]
                            </h4>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- fragmento 3 que se utiliza en la página modifica.html -->
        <section th:fragment="editar">
            <div class="row">
                <div class="col-md-2"></div>
                <div class="col-md-8">
                    <form method="POST" th:action="@{/servicio/guardar}" 
                          th:object="${servicio}" class="was-validated" enctype="multipart/form-data">
                        <input type="hidden" name="idServicio" th:field="*{idServicio}"/>
                        <input type="hidden" name="rutaImagen" th:field="*{rutaImagen}"/>
                        
                        <div class="row py-4 mb-4 bg-light">
                            <div class="col-md-4 d-grid">
                                <a th:href="@{/servicio/listado}" class="btn btn-primary">
                                    <i class="fas fa-arrow-left"></i> Regresar
                                </a>
                            </div>                                
                            <div class="col-md-4 d-grid">
                                <button type="submit" class="btn btn-success">
                                    <i class="fas fa-check"></i> Guardar
                                </button>
                            </div>
                        </div>                        
                        
                        <div class="row">
                            <div class="col">
                                <div class="card">
                                    <div class="card-header">
                                        <h4>Modificar Servicio</h4>
                                    </div>
                                    <div class="card-body">
                                     

                                        <div class="mb-3">
                                            <label>Descripción</label>
                                            <input type="text" class="form-control" name="descripcion" 
                                                   th:field="*{descripcion}" required="true"
                                                   placeholder="Nombre del servicio"/>
                                        </div>
                                        
                                        <div class='mb-3'>
                                            <label>Detalle</label>
                                            <textarea name='detalle' th:field="*{detalle}" 
                                                      class='form-control' rows="3" maxlength="1024"
                                                      placeholder="Descripción detallada del servicio"></textarea>
                                        </div>
                                        
                                        <div class='mb-3'>
                                            <label>Precio (₡)</label>
                                            <input type="number" name='precio' th:field="*{precio}" 
                                                   class='form-control' min="0" step="0.01" required/>
                                        </div>
                                        
                                        <div class='mb-3'>
                                            <label>Duración (minutos)</label>
                                            <input type="number" name='duracionMinutos' 
                                                   th:field="*{duracionMinutos}" 
                                                   class='form-control' min="1" required/>
                                        </div>

                                        <div class="mb-3">
                                            <label>Activo</label>
                                            <input class="form-check-input" type="checkbox" 
                                                   name="activo" id="activoServicio" 
                                                   th:field="*{activo}"/>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label>Imagen</label>
                                            <input class="form-control" type="file" name="imagenFile"
                                                   onchange="mostrarImagenServicio(this);" 
                                                   accept="image/*"/>
                                            <div class="mt-2">
                                                <img id="blah-servicio-edit" 
                                                     th:src="@{${servicio.rutaImagen}}" 
                                                     alt="imagen del servicio" 
                                                     height="200"
                                                     th:if="${servicio.rutaImagen}"
                                                     class="img-thumbnail"/>
                                                <span th:unless="${servicio.rutaImagen}" 
                                                      class="text-muted">Sin imagen</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </section>

        <!-- fragmento 4 para confirmar que se desea eliminar un servicio -->
        <section th:fragment="confirmarEliminar">
            <div class="modal fade" id="confirmModalServicio" tabindex="-1" 
                 aria-labelledby="confirmModalServicioLabel" aria-hidden="true">
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content">
                        <form th:action="@{/servicio/eliminar}" method="post">
                            <input type="hidden" name="idServicio" id="modalIdServicio"/>
                            <div class="modal-header bg-warning text-white">
                                <h5 class="modal-title" id="confirmModalServicioLabel">
                                    <i class="fa-solid fa-triangle-exclamation"></i> Confirmar Eliminación
                                </h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                            </div>
                            <div class="modal-body">
                                <p>¿Está seguro que desea eliminar el servicio <strong id="modalDescripcionServicio"></strong>?</p>
                                <div class="alert alert-warning">
                                    <i class="fa-solid fa-circle-info"></i>
                                    Esta acción no se puede deshacer.
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="submit" class="btn btn-danger">
                                    <i class="fa-solid fa-trash"></i> Eliminar
                                </button>
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                                    <i class="fa-solid fa-xmark"></i> Cancelar
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </section>

        <!-- Script para manejar modales y previsualización de imágenes -->
        <script th:fragment="scripts">
            // Previsualización de imagen para agregar
            function mostrarImagen(input) {
                if (input.files && input.files[0]) {
                    var reader = new FileReader();
                    var imgElement = document.getElementById('blah-servicio');
                    
                    reader.onload = function(e) {
                        imgElement.src = e.target.result;
                        imgElement.classList.remove('d-none');
                    }
                    
                    reader.readAsDataURL(input.files[0]);
                }
            }
            
            // Previsualización de imagen para editar
            function mostrarImagenServicio(input) {
                if (input.files && input.files[0]) {
                    var reader = new FileReader();
                    var imgElement = document.getElementById('blah-servicio-edit');
                    
                    reader.onload = function(e) {
                        imgElement.src = e.target.result;
                    }
                    
                    reader.readAsDataURL(input.files[0]);
                }
            }
            
            // Configurar modal de confirmación para eliminar servicio
            document.addEventListener('DOMContentLoaded', function() {
                const confirmModalServicio = document.getElementById('confirmModalServicio');
                if (confirmModalServicio) {
                    confirmModalServicio.addEventListener('show.bs.modal', function(event) {
                        const button = event.relatedTarget;
                        const id = button.getAttribute('data-bs-id');
                        const descripcion = button.getAttribute('data-bs-descripcion');
                        
                        document.getElementById('modalIdServicio').value = id;
                        document.getElementById('modalDescripcionServicio').textContent = descripcion;
                    });
                }
            });
        </script>
    </body>
</html>